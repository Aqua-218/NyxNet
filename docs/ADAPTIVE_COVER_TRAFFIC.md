# Adaptive Cover Traffic チューニングガイド

Nyx のカバートラフィック (Cover Traffic) は利用率 (Utilization) を観測し送信レート λ を動的調整することで匿名性と帯域 / 電力コストの均衡を図ります。本ガイドは v1.0 実装に合わせた調整原則をまとめます。

## 目的指標
| 指標 | 目標レンジ | 目的 |
|------|-----------|------|
| 利用率 U = 実データバイト / (実データ + ダミー) | 0.2 – 0.6 | 実トラフィック偏在を隠匿しつつ帯域過剰消費回避 |
| 送信ジッタ (p95-p50)/p50 | < 1.2 | タイミング特性の平滑化 |
| ダミー占有率ピーク (短期5s) | < 0.85 | バースト時の過剰抑制 |

## 制御ループ概要
```
観測: 直近 W 秒ウィンドウ (デフォ 1s) で実データバイト数 D とダミー総バイト C を集計
U = D / (D + C)
誤差 e = U_target - U
λ_new = clamp( λ_old * (1 + α * e), λ_min, λ_max )
```
- α: 調整ゲイン (推奨 0.5) 過大だと振動 (オーバーシュート) 増大
- λ_min: 最低ダミー送信レート (Low Power で 0 にならないよう >0) 例: 2 pps
- λ_max: 上限 (DoS 的バースト防止) 例: 200 pps

## 安定化テクニック
| 課題 | 症状 | 対策 |
|------|------|------|
| 振動 (Oscillation) | U が 0.2/0.6 を往復 | 指数移動平均 EMA で U 平滑化 / α を下げる |
| スパイク | 一時的 D 増で λ 急落 | 上昇/下降で非対称ゲイン (α_up != α_down) |
| 長期低利用 | D ≈0 で λ が最小付近停滞 | 定期微増 (heartbeat bump) を 60s 毎に適用 |
| RTT 変動影響 | 遅延経路でダミーパケット固まり | スケジューラ RTT 正規化後に挿入 |

### 平滑化例 (Rust 擬似)
```rust
let u_raw = d as f64 / (d + c).max(1) as f64;
state.u_ema = state.u_ema * 0.7 + u_raw * 0.3; // β=0.3
let e = target - state.u_ema;
```

## 推奨設定プリセット
| プロファイル | target | α | α_up/α_down | λ_min | λ_max | 用途 |
|--------------|--------|----|-------------|-------|-------|------|
| Balanced | 0.4 | 0.5 | – | 2 | 200 | 汎用 |
| HighPrivacy | 0.35 | 0.4 | – | 5 | 300 | 匿名性重視 (帯域↑) |
| LowPowerBlend | 0.45 | – | 0.6 / 0.3 | 1 | 120 | 低電力と両立 |

## Telemetry 連携
`nyx_telemetry` へ以下を追加提案（未実装なら拡張余地）:
- Counter: `nyx_cover_adjustments_total`
- Gauge: `nyx_cover_lambda_current`
- Histogram: `nyx_cover_utilization` (Bucket: 0.0..1.0 step 0.05)

アラート例:
- 5 分平均 U < 0.15 → Under-cover (匿名性リスク)
- 5 分平均 U > 0.7 かつ λ_current ≈ λ_min → ダミー不足 (本来実増?)
- 調整失敗率 (連続 10 回で変化 <1%) → ゲイン再調整候補

## Low Power モードとの協調
低電力遷移時に target を 0.4→0.55 に一過的昇格し λ をゆるやかに減衰 (指数緩和) することで急激な統計変化を隠蔽。
```
λ_decay(t) = λ_entry * e^{-k t} + λ_lp * (1 - e^{-k t})
```
- k: 0.15–0.25 推奨 (10–15s で 80% 収束)

## デバッグ指標（開発時のみログ）
- `U_raw, U_ema, λ_old, λ_new, reason(adjust|decay|heartbeat)`
- 1 分間隔スナップショットを sampling-ratio 低めで tracing 出力

## よくある調整失敗パターン
| 症状 | 原因 | 修正 |
|------|------|------|
| λ が上下に振り続け収束しない | ゲイン過大, EMA β=1 | α と β を半減 |
| U が常時 0.1 付近 | λ_min が低すぎ | λ_min 引き上げ / target 低下 |
| 高負荷時に λ が急増して帯域飽和 | λ_max 過大 | λ_max 降下 / 非対称ゲイン導入 |

## 将来拡張
- PID 制御 (積分項でバイアス除去、微分でスパイク緩和)
- 利用率以外の指標（エントロピー / burstiness）複合最適化
- 経路ごとの差異 (per-path dummy shaping)

---
最終更新: 手動。Spec 差分スクリプトはキーワードのみ把握 ("cover" / "utilization").
